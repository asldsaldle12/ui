-- Improved Drawing-based UI Library inspired by Linoria
-- Made more beautiful with shadows, outlines, tooltips, and basic animations
-- Implements core elements: Window, Tab, Groupbox, Toggle, Button (with sub), Label, Slider
-- Added Dropdown, ColorPicker, Keybind, Textbox for fullness
-- ThemeManager and SaveManager included
-- No restrictions, full freedom as per style

local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")

-- Lerp function for animations
local function lerp(a, b, t)
    if typeof(a) == "number" then
        return a + (b - a) * t
    elseif typeof(a) == "Color3" then
        return a:Lerp(b, t)
    elseif typeof(a) == "Vector2" then
        return a + (b - a) * t
    end
    return a
end

-- Tween function
local function tween(object, property, value, time)
    time = time or 0.2
    local start = object[property]
    local startTime = tick()
    local conn
    conn = RS.Heartbeat:Connect(function()
        local alpha = math.min(1, (tick() - startTime) / time)
        object[property] = lerp(start, value, alpha)
        if alpha >= 1 then
            conn:Disconnect()
        end
    end)
end

-- Global tables
Toggles = {}
Options = {}

-- Theme
local Theme = {
    Background = Color3.fromRGB(25, 25, 25),
    Accent = Color3.fromRGB(100, 149, 237),
    Text = Color3.fromRGB(255, 255, 255),
    Outline = Color3.fromRGB(50, 50, 50),
    Shadow = Color3.fromRGB(0, 0, 0),
    Font = 1, -- Drawing.Fonts.UI (assuming 1 is UI)
    TextSize = 13,
}

-- Library
local Library = {}
Library.Windows = {}

function Library:CreateWindow(options)
    local Window = {}
    Window.Title = options.Title or "UI"
    local viewport = workspace.CurrentCamera.ViewportSize
    Window.Position = options.Center and (Vector2.new(viewport.X, viewport.Y) / 2 - (options.Size or Vector2.new(500, 300)) / 2) or Vector2.new(100, 100)
    Window.Size = options.Size or Vector2.new(500, 300)
    Window.Visible = options.AutoShow or false
    Window.Tabs = {}
    Window.SelectedTab = nil

    -- Drawings
    Window.Shadow = Drawing.new("Square")
    Window.Shadow.Filled = true
    Window.Shadow.Color = Theme.Shadow
    Window.Shadow.Transparency = 0.7
    Window.Shadow.Size = Window.Size + Vector2.new(10, 10)
    Window.Shadow.Position = Window.Position - Vector2.new(5, 5)
    Window.Shadow.Visible = Window.Visible

    Window.Background = Drawing.new("Square")
    Window.Background.Filled = true
    Window.Background.Color = Theme.Background
    Window.Background.Size = Window.Size
    Window.Background.Position = Window.Position
    Window.Background.Visible = Window.Visible

    Window.Outline = Drawing.new("Square")
    Window.Outline.Filled = false
    Window.Outline.Color = Theme.Outline
    Window.Outline.Thickness = 1
    Window.Outline.Position = Window.Position - Vector2.new(1, 1)
    Window.Outline.Size = Window.Size + Vector2.new(2, 2)
    Window.Outline.Visible = Window.Visible

    Window.Titlebar = Drawing.new("Square")
    Window.Titlebar.Filled = true
    Window.Titlebar.Color = Theme.Accent
    Window.Titlebar.Size = Vector2.new(Window.Size.X, 25)
    Window.Titlebar.Position = Window.Position
    Window.Titlebar.Visible = Window.Visible

    Window.TitleText = Drawing.new("Text")
    Window.TitleText.Text = Window.Title
    Window.TitleText.Position = Window.Position + Vector2.new(10, 5)
    Window.TitleText.Size = 14
    Window.TitleText.Font = Theme.Font
    Window.TitleText.Color = Theme.Text
    Window.TitleText.Visible = Window.Visible

    Window.CloseBtn = Drawing.new("Square")
    Window.CloseBtn.Filled = true
    Window.CloseBtn.Color = Color3.fromRGB(255, 0, 0)
    Window.CloseBtn.Size = Vector2.new(15, 15)
    Window.CloseBtn.Position = Window.Position + Vector2.new(Window.Size.X - 20, 5)
    Window.CloseBtn.Visible = Window.Visible

    Window.CloseText = Drawing.new("Text")
    Window.CloseText.Text = "X"
    Window.CloseText.Position = Window.CloseBtn.Position + Vector2.new(3, 0)
    Window.CloseText.Size = 12
    Window.CloseText.Color = Theme.Text
    Window.CloseText.Visible = Window.Visible

    Window.TabSidebar = Drawing.new("Square")
    Window.TabSidebar.Filled = true
    Window.TabSidebar.Color = Theme.Outline
    Window.TabSidebar.Size = Vector2.new(150, Window.Size.Y - 25)
    Window.TabSidebar.Position = Window.Position + Vector2.new(0, 25)
    Window.TabSidebar.Visible = Window.Visible

    Window.TabArea = Window.Position + Vector2.new(150, 25)
    Window.TabSize = Vector2.new(Window.Size.X - 150, Window.Size.Y - 25)

    table.insert(Library.Windows, Window)

    local dragging = false
    local dragStart

    local function updateVisibility()
        for _, v in pairs(Window) do
            if type(v) == "table" and v.__OBJECT_EXISTS then
                v.Visible = Window.Visible
            end
        end
        for _, tab in ipairs(Window.Tabs) do
            for _, gb in ipairs(tab.Groupboxes) do
                gb.Visible = Window.Visible and tab.Visible
                for _, elem in ipairs(gb.Elements) do
                    elem:Show()
                end
            end
        end
    end

    UIS.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local mouse = UIS:GetMouseLocation()
            if mouse.X > Window.CloseBtn.Position.X and mouse.X < Window.CloseBtn.Position.X + 15 and mouse.Y > Window.CloseBtn.Position.Y and mouse.Y < Window.CloseBtn.Position.Y + 15 then
                Window.Visible = false
                updateVisibility()
            end
            if mouse.X > Window.Titlebar.Position.X and mouse.X < Window.Titlebar.Position.X + Window.Titlebar.Size.X and mouse.Y > Window.Titlebar.Position.Y and mouse.Y < Window.Titlebar.Position.Y + Window.Titlebar.Size.Y then
                dragging = true
                dragStart = mouse - Window.Position
            end
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local mouse = UIS:GetMouseLocation()
            Window.Position = mouse - dragStart
            Window.Shadow.Position = Window.Position - Vector2.new(5, 5)
            Window.Background.Position = Window.Position
            Window.Outline.Position = Window.Position - Vector2.new(1, 1)
            Window.Titlebar.Position = Window.Position
            Window.TitleText.Position = Window.Position + Vector2.new(10, 5)
            Window.CloseBtn.Position = Window.Position + Vector2.new(Window.Size.X - 20, 5)
            Window.CloseText.Position = Window.CloseBtn.Position + Vector2.new(3, 0)
            Window.TabSidebar.Position = Window.Position + Vector2.new(0, 25)
            Window.TabArea = Window.Position + Vector2.new(150, 25)
            for i, tab in ipairs(Window.Tabs) do
                tab.TabButton.Position = Window.Position + Vector2.new(1, 25 + 31 * (i - 1))
                tab.TabText.Position = tab.TabButton.Position + Vector2.new(10, 5)
                for _, gb in ipairs(tab.Groupboxes) do
                    gb:UpdatePosition()
                end
            end
        end
    end)

    UIS.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    function Window:AddTab(title)
        local Tab = {}
        Tab.Title = title
        Tab.Groupboxes = {}
        Tab.Visible = false

        Tab.TabButton = Drawing.new("Square")
        Tab.TabButton.Filled = true
        Tab.TabButton.Color = Theme.Background
        Tab.TabButton.Size = Vector2.new(148, 30)
        Tab.TabButton.Position = Window.Position + Vector2.new(1, 25 + 31 * #Window.Tabs)
        Tab.TabButton.Visible = Window.Visible

        Tab.TabText = Drawing.new("Text")
        Tab.TabText.Text = title
        Tab.TabText.Position = Tab.TabButton.Position + Vector2.new(10, 5)
        Tab.TabText.Size = Theme.TextSize
        Tab.TabText.Color = Theme.Text
        Tab.TabText.Visible = Window.Visible

        table.insert(Window.Tabs, Tab)

        local function selectTab()
            if Window.SelectedTab then
                Window.SelectedTab.Visible = false
                for _, gb in ipairs(Window.SelectedTab.Groupboxes) do
                    gb:Hide()
                end
            end
            Window.SelectedTab = Tab
            Tab.Visible = true
            Tab.TabButton.Color = Theme.Accent
            for _, t in ipairs(Window.Tabs) do
                if t ~= Tab then
                    t.TabButton.Color = Theme.Background
                end
            end
            for _, gb in ipairs(Tab.Groupboxes) do
                gb:Show()
            end
        end

        if #Window.Tabs == 1 then
            selectTab()
        end

        UIS.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                local mouse = UIS:GetMouseLocation()
                if mouse.X > Tab.TabButton.Position.X and mouse.X < Tab.TabButton.Position.X + Tab.TabButton.Size.X and mouse.Y > Tab.TabButton.Position.Y and mouse.Y < Tab.TabButton.Position.Y + Tab.TabButton.Size.Y then
                    selectTab()
                end
            end
        end)

        function Tab:AddLeftGroupbox(title)
            local Groupbox = {}
            Groupbox.Title = title
            Groupbox.Position = Window.TabArea + Vector2.new(10, 10)
            Groupbox.Size = Vector2.new((Window.TabSize.X - 30) / 2, Window.TabSize.Y - 20)
            Groupbox.Elements = {}
            Groupbox.CurrentY = 30
            Groupbox.Visible = Tab.Visible

            Groupbox.Background = Drawing.new("Square")
            Groupbox.Background.Filled = true
            Groupbox.Background.Color = Theme.Outline
            Groupbox.Background.Position = Groupbox.Position
            Groupbox.Background.Size = Groupbox.Size
            Groupbox.Background.Visible = Groupbox.Visible

            Groupbox.TitleText = Drawing.new("Text")
            Groupbox.TitleText.Text = title
            Groupbox.TitleText.Position = Groupbox.Position + Vector2.new(10, 5)
            Groupbox.TitleText.Size = Theme.TextSize
            Groupbox.TitleText.Color = Theme.Text
            Groupbox.TitleText.Visible = Groupbox.Visible

            table.insert(Tab.Groupboxes, Groupbox)

            function Groupbox:UpdatePosition()
                Groupbox.Background.Position = Groupbox.Position
                Groupbox.TitleText.Position = Groupbox.Position + Vector2.new(10, 5)
                local y = 30
                for _, elem in ipairs(Groupbox.Elements) do
                    elem:UpdatePosition(Groupbox.Position + Vector2.new(10, y))
                    y = y + elem.Height + 5
                end
            end

            function Groupbox:Show()
                Groupbox.Visible = true
                Groupbox.Background.Visible = true
                Groupbox.TitleText.Visible = true
                for _, elem in ipairs(Groupbox.Elements) do
                    elem:Show()
                end
            end

            function Groupbox:Hide()
                Groupbox.Visible = false
                Groupbox.Background.Visible = false
                Groupbox.TitleText.Visible = false
                for _, elem in ipairs(Groupbox.Elements) do
                    elem:Hide()
                end
            end

            function Groupbox:AddToggle(flag, opt)
                local Toggle = {}
                Toggle.Text = opt.Text or "Toggle"
                Toggle.Default = opt.Default or false
                Toggle.Tooltip = opt.Tooltip or nil
                Toggle.Value = Toggle.Default
                Toggle.Callback = nil
                Toggle.Height = 20

                Toggle.Label = Drawing.new("Text")
                Toggle.Label.Text = Toggle.Text
                Toggle.Label.Size = Theme.TextSize
                Toggle.Label.Color = Theme.Text
                Toggle.Label.Visible = Groupbox.Visible

                Toggle.Box = Drawing.new("Square")
                Toggle.Box.Size = Vector2.new(15, 15)
                Toggle.Box.Filled = true
                Toggle.Box.Color = Toggle.Value and Theme.Accent or Theme.Background
                Toggle.Box.Visible = Groupbox.Visible

                local function toggleValue()
                    local newValue = not Toggle.Value
                    local newColor = newValue and Theme.Accent or Theme.Background
                    tween(Toggle.Box, "Color", newColor, 0.15)
                    Toggle.Value = newValue
                    if Toggle.Callback then Toggle.Callback(Toggle.Value) end
                end

                UIS.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        local mouse = UIS:GetMouseLocation()
                        if mouse.X > Toggle.Box.Position.X and mouse.X < Toggle.Box.Position.X + 15 and mouse.Y > Toggle.Box.Position.Y and mouse.Y < Toggle.Box.Position.Y + 15 then
                            toggleValue()
                        end
                    end
                end)

                function Toggle:OnChanged(cb)
                    Toggle.Callback = cb
                end

                function Toggle:SetValue(val)
                    local newColor = val and Theme.Accent or Theme.Background
                    tween(Toggle.Box, "Color", newColor, 0.15)
                    Toggle.Value = val
                    if Toggle.Callback then Toggle.Callback(val) end
                end

                if Toggle.Tooltip then
                    Toggle.TooltipText = Drawing.new("Text")
                    Toggle.TooltipText.Text = Toggle.Tooltip
                    Toggle.TooltipText.Color = Theme.Text
                    Toggle.TooltipText.Size = 12
                    Toggle.TooltipText.Visible = false

                    RS.Heartbeat:Connect(function()
                        local mouse = UIS:GetMouseLocation()
                        local bounds = Toggle.Label.TextBounds
                        if mouse.X > Toggle.Label.Position.X and mouse.X < Toggle.Label.Position.X + bounds.X and mouse.Y > Toggle.Label.Position.Y and mouse.Y < Toggle.Label.Position.Y + Theme.TextSize then
                            Toggle.TooltipText.Position = mouse + Vector2.new(10, 10)
                            Toggle.TooltipText.Visible = true
                        else
                            Toggle.TooltipText.Visible = false
                        end
                    end)
                end

                function Toggle:UpdatePosition(pos)
                    Toggle.Label.Position = pos
                    Toggle.Box.Position = pos + Vector2.new(Groupbox.Size.X - 40, 0)
                end

                function Toggle:Show()
                    Toggle.Label.Visible = true
                    Toggle.Box.Visible = true
                    if Toggle.TooltipText then Toggle.TooltipText.Visible = true end -- managed by hover
                end

                function Toggle:Hide()
                    Toggle.Label.Visible = false
                    Toggle.Box.Visible = false
                    if Toggle.TooltipText then Toggle.TooltipText.Visible = false end
                end

                table.insert(Groupbox.Elements, Toggle)
                Groupbox.CurrentY = Groupbox.CurrentY + Toggle.Height + 5
                Toggle:UpdatePosition(Groupbox.Position + Vector2.new(10, Groupbox.CurrentY - Toggle.Height - 5))
                Toggles[flag] = Toggle
                return Toggle
            end

            function Groupbox:AddButton(text, cb)
                local Button = {}
                Button.Text = text
                Button.Callback = cb
                Button.Height = 25
                Button.SubButtons = {}

                Button.Bg = Drawing.new("Square")
                Button.Bg.Filled = true
                Button.Bg.Color = Theme.Accent
                Button.Bg.Size = Vector2.new(Groupbox.Size.X - 20, Button.Height)
                Button.Bg.Visible = Groupbox.Visible

                Button.Label = Drawing.new("Text")
                Button.Label.Text = text
                Button.Label.Size = Theme.TextSize
                Button.Label.Color = Theme.Text
                Button.Label.Visible = Groupbox.Visible

                UIS.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        local mouse = UIS:GetMouseLocation()
                        if mouse.X > Button.Bg.Position.X and mouse.X < Button.Bg.Position.X + Button.Bg.Size.X and mouse.Y > Button.Bg.Position.Y and mouse.Y < Button.Bg.Position.Y + Button.Bg.Size.Y then
                            if Button.Callback then Button.Callback() end
                        end
                    end
                end)

                function Button:AddTooltip(tooltip)
                    Button.Tooltip = tooltip
                    Button.TooltipText = Drawing.new("Text")
                    Button.TooltipText.Text = tooltip
                    Button.TooltipText.Color = Theme.Text
                    Button.TooltipText.Size = 12
                    Button.TooltipText.Visible = false

                    RS.Heartbeat:Connect(function()
                        local mouse = UIS:GetMouseLocation()
                        if mouse.X > Button.Bg.Position.X and mouse.X < Button.Bg.Position.X + Button.Bg.Size.X and mouse.Y > Button.Bg.Position.Y and mouse.Y < Button.Bg.Position.Y + Button.Bg.Size.Y then
                            Button.TooltipText.Position = mouse + Vector2.new(10, 10)
                            Button.TooltipText.Visible = true
                        else
                            Button.TooltipText.Visible = false
                        end
                    end)
                end

                function Button:AddButton(subtext, subcb)
                    local SubButton = {}
                    SubButton.Text = subtext
                    SubButton.Callback = subcb
                    SubButton.Height = Button.Height

                    Button.Bg.Size = Vector2.new((Groupbox.Size.X - 25) / 2, Button.Height)

                    SubButton.Bg = Drawing.new("Square")
                    SubButton.Bg.Filled = true
                    SubButton.Bg.Color = Theme.Accent
                    SubButton.Bg.Size = Vector2.new((Groupbox.Size.X - 25) / 2, Button.Height)
                    SubButton.Bg.Visible = Groupbox.Visible

                    SubButton.Label = Drawing.new("Text")
                    SubButton.Label.Text = subtext
                    SubButton.Label.Size = Theme.TextSize
                    SubButton.Label.Color = Theme.Text
                    SubButton.Label.Visible = Groupbox.Visible

                    UIS.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            local mouse = UIS:GetMouseLocation()
                            if mouse.X > SubButton.Bg.Position.X and mouse.X < SubButton.Bg.Position.X + SubButton.Bg.Size.X and mouse.Y > SubButton.Bg.Position.Y and mouse.Y < SubButton.Bg.Position.Y + SubButton.Bg.Size.Y then
                                if SubButton.Callback then SubButton.Callback() end
                            end
                        end
                    end)

                    function SubButton:AddTooltip(tooltip)
                        SubButton.Tooltip = tooltip
                        -- similar hover logic as above
                        SubButton.TooltipText = Drawing.new("Text")
                        SubButton.TooltipText.Text = tooltip
                        SubButton.TooltipText.Color = Theme.Text
                        SubButton.TooltipText.Size = 12
                        SubButton.TooltipText.Visible = false

                        RS.Heartbeat:Connect(function()
                            local mouse = UIS:GetMouseLocation()
                            if mouse.X > SubButton.Bg.Position.X and mouse.X < SubButton.Bg.Position.X + SubButton.Bg.Size.X and mouse.Y > SubButton.Bg.Position.Y and mouse.Y < SubButton.Bg.Position.Y + SubButton.Bg.Size.Y then
                                SubButton.TooltipText.Position = mouse + Vector2.new(10, 10)
                                SubButton.TooltipText.Visible = true
                            else
                                SubButton.TooltipText.Visible = false
                            end
                        end)
                    end

                    table.insert(Button.SubButtons, SubButton)

                    function SubButton:UpdatePosition(pos)
                        SubButton.Bg.Position = pos + Vector2.new(Button.Bg.Size.X + 5, 0)
                        SubButton.Label.Position = SubButton.Bg.Position + Vector2.new(5, 5)
                    end

                    function SubButton:Show()
                        SubButton.Bg.Visible = true
                        SubButton.Label.Visible = true
                    end

                    function SubButton:Hide()
                        SubButton.Bg.Visible = false
                        SubButton.Label.Visible = false
                    end

                    return SubButton
                end

                function Button:UpdatePosition(pos)
                    Button.Bg.Position = pos
                    Button.Label.Position = pos + Vector2.new(5, 5)
                    if #Button.SubButtons > 0 then
                        Button.SubButtons[1]:UpdatePosition(pos)
                    end
                end

                function Button:Show()
                    Button.Bg.Visible = true
                    Button.Label.Visible = true
                    for _, sub in ipairs(Button.SubButtons) do
                        sub:Show()
                    end
                end

                function Button:Hide()
                    Button.Bg.Visible = false
                    Button.Label.Visible = false
                    for _, sub in ipairs(Button.SubButtons) do
                        sub:Hide()
                    end
                end

                table.insert(Groupbox.Elements, Button)
                Groupbox.CurrentY = Groupbox.CurrentY + Button.Height + 5
                Button:UpdatePosition(Groupbox.Position + Vector2.new(10, Groupbox.CurrentY - Button.Height - 5))
                return Button
            end

            function Groupbox:AddLabel(text, wrap)
                local Label = {}
                Label.Text = text
                Label.Wrap = wrap or false
                Label.Height = wrap and 30 or 15

                Label.Label = Drawing.new("Text")
                Label.Label.Text = text
                Label.Label.Size = Theme.TextSize
                Label.Label.Color = Theme.Text
                Label.Label.Visible = Groupbox.Visible

                function Label:UpdatePosition(pos)
                    Label.Label.Position = pos
                end

                function Label:Show()
                    Label.Label.Visible = true
                end

                function Label:Hide()
                    Label.Label.Visible = false
                end

                table.insert(Groupbox.Elements, Label)
                Groupbox.CurrentY = Groupbox.CurrentY + Label.Height + 5
                Label:UpdatePosition(Groupbox.Position + Vector2.new(10, Groupbox.CurrentY - Label.Height - 5))
                return Label
            end

            function Groupbox:AddSlider(flag, opt)
                local Slider = {}
                Slider.Text = opt.Text or "Slider"
                Slider.Min = opt.Min or 0
                Slider.Max = opt.Max or 100
                Slider.Value = opt.Default or Slider.Min
                Slider.Rounding = opt.Rounding or 0
                Slider.Compact = opt.Compact or false
                Slider.Callback = nil
                Slider.Height = 25

                Slider.Label = Drawing.new("Text")
                Slider.Label.Text = Slider.Text
                Slider.Label.Size = Theme.TextSize
                Slider.Label.Color = Theme.Text
                Slider.Label.Visible = Groupbox.Visible and not Slider.Compact

                Slider.Bar = Drawing.new("Square")
                Slider.Bar.Filled = true
                Slider.Bar.Color = Theme.Outline
                Slider.Bar.Size = Vector2.new(Groupbox.Size.X - 40, 5)
                Slider.Bar.Visible = Groupbox.Visible

                Slider.Fill = Drawing.new("Square")
                Slider.Fill.Filled = true
                Slider.Fill.Color = Theme.Accent
                Slider.Fill.Size = Vector2.new(0, 5)
                Slider.Fill.Position = Slider.Bar.Position
                Slider.Fill.Visible = Groupbox.Visible

                Slider.ValueText = Drawing.new("Text")
                Slider.ValueText.Text = tostring(math.round(Slider.Value * 10 ^ Slider.Rounding) / 10 ^ Slider.Rounding)
                Slider.ValueText.Size = Theme.TextSize
                Slider.ValueText.Color = Theme.Text
                Slider.ValueText.Visible = Groupbox.Visible

                local sliding = false

                UIS.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        local mouse = UIS:GetMouseLocation()
                        if mouse.X > Slider.Bar.Position.X and mouse.X < Slider.Bar.Position.X + Slider.Bar.Size.X and mouse.Y > Slider.Bar.Position.Y and mouse.Y < Slider.Bar.Position.Y + Slider.Bar.Size.Y then
                            sliding = true
                        end
                    end
                end)

                UIS.InputChanged:Connect(function(input)
                    if sliding and input.UserInputType == Enum.UserInputType.MouseMovement then
                        local mouse = UIS:GetMouseLocation()
                        local rel = math.clamp((mouse.X - Slider.Bar.Position.X) / Slider.Bar.Size.X, 0, 1)
                        Slider.Value = Slider.Min + (Slider.Max - Slider.Min) * rel
                        Slider.Value = math.round(Slider.Value * 10 ^ Slider.Rounding) / 10 ^ Slider.Rounding
                        Slider.Fill.Size = Vector2.new(rel * Slider.Bar.Size.X, 5)
                        Slider.ValueText.Text = tostring(Slider.Value)
                        if Slider.Callback then Slider.Callback(Slider.Value) end
                    end
                end)

                UIS.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        sliding = false
                    end
                end)

                function Slider:OnChanged(cb)
                    Slider.Callback = cb
                end

                function Slider:SetValue(val)
                    val = math.clamp(val, Slider.Min, Slider.Max)
                    val = math.round(val * 10 ^ Slider.Rounding) / 10 ^ Slider.Rounding
                    Slider.Value = val
                    local rel = (val - Slider.Min) / (Slider.Max - Slider.Min)
                    tween(Slider.Fill, "Size", Vector2.new(rel * Slider.Bar.Size.X, 5), 0.15)
                    Slider.ValueText.Text = tostring(val)
                    if Slider.Callback then Slider.Callback(val) end
                end

                function Slider:UpdatePosition(pos)
                    Slider.Label.Position = pos
                    Slider.Bar.Position = pos + Vector2.new(0, 15)
                    Slider.Fill.Position = Slider.Bar.Position
                    Slider.ValueText.Position = Slider.Bar.Position + Vector2.new(Slider.Bar.Size.X + 5, -5)
                end

                function Slider:Show()
                    Slider.Label.Visible = not Slider.Compact
                    Slider.Bar.Visible = true
                    Slider.Fill.Visible = true
                    Slider.ValueText.Visible = true
                end

                function Slider:Hide()
                    Slider.Label.Visible = false
                    Slider.Bar.Visible = false
                    Slider.Fill.Visible = false
                    Slider.ValueText.Visible = false
                end

                table.insert(Groupbox.Elements, Slider)
                Groupbox.CurrentY = Groupbox.CurrentY + Slider.Height + 5
                Slider:UpdatePosition(Groupbox.Position + Vector2.new(10, Groupbox.CurrentY - Slider.Height - 5))
                Options[flag] = Slider
                return Slider
            end

            -- Additional elements for fullness

            function Groupbox:AddDropdown(flag, opt)
                local Dropdown = {}
                Dropdown.Text = opt.Text or "Dropdown"
                Dropdown.Values = opt.Values or {}
                Dropdown.Default = opt.Default or Dropdown.Values[1]
                Dropdown.AllowNull = opt.AllowNull or false
                Dropdown.Value = Dropdown.Default
                Dropdown.Callback = nil
                Dropdown.Open = false
                Dropdown.Height = 35

                Dropdown.Label = Drawing.new("Text")
                Dropdown.Label.Text = Dropdown.Text
                Dropdown.Label.Size = Theme.TextSize
                Dropdown.Label.Color = Theme.Text
                Dropdown.Label.Visible = Groupbox.Visible

                Dropdown.Box = Drawing.new("Square")
                Dropdown.Box.Filled = true
                Dropdown.Box.Color = Theme.Background
                Dropdown.Box.Size = Vector2.new(Groupbox.Size.X - 40, 20)
                Dropdown.Box.Visible = Groupbox.Visible

                Dropdown.ValueText = Drawing.new("Text")
                Dropdown.ValueText.Text = Dropdown.Value or "None"
                Dropdown.ValueText.Position = Dropdown.Box.Position + Vector2.new(5, 2)
                Dropdown.ValueText.Size = Theme.TextSize
                Dropdown.ValueText.Color = Theme.Text
                Dropdown.ValueText.Visible = Groupbox.Visible

                Dropdown.OptionTexts = {}
                for i, val in ipairs(Dropdown.Values) do
                    local txt = Drawing.new("Text")
                    txt.Text = val
                    txt.Size = Theme.TextSize
                    txt.Color = Theme.Text
                    txt.Visible = false
                    table.insert(Dropdown.OptionTexts, txt)
                end

                UIS.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        local mouse = UIS:GetMouseLocation()
                        if mouse.X > Dropdown.Box.Position.X and mouse.X < Dropdown.Box.Position.X + Dropdown.Box.Size.X and mouse.Y > Dropdown.Box.Position.Y and mouse.Y < Dropdown.Box.Position.Y + Dropdown.Box.Size.Y then
                            Dropdown.Open = not Dropdown.Open
                            for _, txt in ipairs(Dropdown.OptionTexts) do
                                txt.Visible = Dropdown.Open and Groupbox.Visible
                            end
                        end
                        if Dropdown.Open then
                            for i, txt in ipairs(Dropdown.OptionTexts) do
                                if mouse.X > Dropdown.Box.Position.X and mouse.X < Dropdown.Box.Position.X + Dropdown.Box.Size.X and mouse.Y > Dropdown.Box.Position.Y + 20 * i and mouse.Y < Dropdown.Box.Position.Y + 20 * (i + 1) then
                                    Dropdown.Value = Dropdown.Values[i]
                                    Dropdown.ValueText.Text = Dropdown.Value
                                    if Dropdown.Callback then Dropdown.Callback(Dropdown.Value) end
                                    Dropdown.Open = false
                                    for _, t in ipairs(Dropdown.OptionTexts) do t.Visible = false end
                                end
                            end
                        end
                    end
                end)

                function Dropdown:OnChanged(cb)
                    Dropdown.Callback = cb
                end

                function Dropdown:SetValue(val)
                    if table.find(Dropdown.Values, val) or (val == nil and Dropdown.AllowNull) then
                        Dropdown.Value = val
                        Dropdown.ValueText.Text = val or "None"
                        if Dropdown.Callback then Dropdown.Callback(val) end
                    end
                end

                function Dropdown:UpdatePosition(pos)
                    Dropdown.Label.Position = pos
                    Dropdown.Box.Position = pos + Vector2.new(0, 15)
                    Dropdown.ValueText.Position = Dropdown.Box.Position + Vector2.new(5, 2)
                    for i, txt in ipairs(Dropdown.OptionTexts) do
                        txt.Position = Dropdown.Box.Position + Vector2.new(5, 20 * i)
                    end
                end

                function Dropdown:Show()
                    Dropdown.Label.Visible = true
                    Dropdown.Box.Visible = true
                    Dropdown.ValueText.Visible = true
                    if Dropdown.Open then
                        for _, txt in ipairs(Dropdown.OptionTexts) do
                            txt.Visible = true
                        end
                    end
                end

                function Dropdown:Hide()
                    Dropdown.Label.Visible = false
                    Dropdown.Box.Visible = false
                    Dropdown.ValueText.Visible = false
                    for _, txt in ipairs(Dropdown.OptionTexts) do
                        txt.Visible = false
                    end
                end

                table.insert(Groupbox.Elements, Dropdown)
                Groupbox.CurrentY = Groupbox.CurrentY + Dropdown.Height + 5
                Dropdown:UpdatePosition(Groupbox.Position + Vector2.new(10, Groupbox.CurrentY - Dropdown.Height - 5))
                Options[flag] = Dropdown
                return Dropdown
            end

            -- Simple ColorPicker with RGB sliders
            function Groupbox:AddColorpicker(flag, opt)
                local Colorpicker = {}
                Colorpicker.Text = opt.Text or "Colorpicker"
                Colorpicker.Default = opt.Default or Color3.new(1, 1, 1)
                Colorpicker.Value = Colorpicker.Default
                Colorpicker.Callback = nil
                Colorpicker.Height = 80

                Colorpicker.Label = Drawing.new("Text")
                Colorpicker.Label.Text = Colorpicker.Text
                Colorpicker.Label.Size = Theme.TextSize
                Colorpicker.Label.Color = Theme.Text
                Colorpicker.Label.Visible = Groupbox.Visible

                -- RGB sliders
                Colorpicker.RSlider = Groupbox:AddSlider(flag .. "_R", {Text = "R", Min = 0, Max = 1, Rounding = 2, Default = Colorpicker.Default.R, Compact = false})
                Colorpicker.GSlider = Groupbox:AddSlider(flag .. "_G", {Text = "G", Min = 0, Max = 1, Rounding = 2, Default = Colorpicker.Default.G, Compact = false})
                Colorpicker.BSlider = Groupbox:AddSlider(flag .. "_B", {Text = "B", Min = 0, Max = 1, Rounding = 2, Default = Colorpicker.Default.B, Compact = false})

                local function updateColor()
                    Colorpicker.Value = Color3.new(Colorpicker.RSlider.Value, Colorpicker.GSlider.Value, Colorpicker.BSlider.Value)
                    if Colorpicker.Callback then Colorpicker.Callback(Colorpicker.Value) end
                end

                Colorpicker.RSlider:OnChanged(updateColor)
                Colorpicker.GSlider:OnChanged(updateColor)
                Colorpicker.BSlider:OnChanged(updateColor)

                function Colorpicker:OnChanged(cb)
                    Colorpicker.Callback = cb
                end

                function Colorpicker:SetValue(val)
                    Colorpicker.RSlider:SetValue(val.R)
                    Colorpicker.GSlider:SetValue(val.G)
                    Colorpicker.BSlider:SetValue(val.B)
                end

                function Colorpicker:UpdatePosition(pos)
                    Colorpicker.Label.Position = pos
                    -- Sliders are already updated as they are added to elements
                end

                function Colorpicker:Show()
                    Colorpicker.Label.Visible = true
                end

                function Colorpicker:Hide()
                    Colorpicker.Label.Visible = false
                end

                table.insert(Groupbox.Elements, Colorpicker)
                Groupbox.CurrentY = Groupbox.CurrentY + Colorpicker.Height + 5
                Colorpicker:UpdatePosition(Groupbox.Position + Vector2.new(10, Groupbox.CurrentY - Colorpicker.Height - 5))
                Options[flag] = Colorpicker
                return Colorpicker
            end

            -- Keybind
            function Groupbox:AddKeybind(flag, opt)
                local Keybind = {}
                Keybind.Text = opt.Text or "Keybind"
                Keybind.Default = opt.Default or Enum.KeyCode.F
                Keybind.Callback = opt.Callback or function() end
                Keybind.Value = Keybind.Default
                Keybind.Waiting = false
                Keybind.Height = 20

                Keybind.Label = Drawing.new("Text")
                Keybind.Label.Text = Keybind.Text
                Keybind.Label.Size = Theme.TextSize
                Keybind.Label.Color = Theme.Text
                Keybind.Label.Visible = Groupbox.Visible

                Keybind.Box = Drawing.new("Square")
                Keybind.Box.Size = Vector2.new(50, 15)
                Keybind.Box.Filled = true
                Keybind.Box.Color = Theme.Background
                Keybind.Box.Visible = Groupbox.Visible

                Keybind.KeyText = Drawing.new("Text")
                Keybind.KeyText.Text = Keybind.Value.Name
                Keybind.KeyText.Position = Keybind.Box.Position + Vector2.new(5, 0)
                Keybind.KeyText.Size = Theme.TextSize
                Keybind.KeyText.Color = Theme.Text
                Keybind.KeyText.Visible = Groupbox.Visible

                UIS.InputBegan:Connect(function(input)
                    if Keybind.Waiting then
                        if input.UserInputType == Enum.UserInputType.Keyboard then
                            Keybind.Value = input.KeyCode
                            Keybind.KeyText.Text = input.KeyCode.Name
                            Keybind.Waiting = false
                        end
                        return
                    end
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        local mouse = UIS:GetMouseLocation()
                        if mouse.X > Keybind.Box.Position.X and mouse.X < Keybind.Box.Position.X + 50 and mouse.Y > Keybind.Box.Position.Y and mouse.Y < Keybind.Box.Position.Y + 15 then
                            Keybind.Waiting = true
                            Keybind.KeyText.Text = "..."
                        end
                    end
                    if input.KeyCode == Keybind.Value then
                        Keybind.Callback()
                    end
                end)

                function Keybind:UpdatePosition(pos)
                    Keybind.Label.Position = pos
                    Keybind.Box.Position = pos + Vector2.new(Groupbox.Size.X - 90, 0)
                    Keybind.KeyText.Position = Keybind.Box.Position + Vector2.new(5, 0)
                end

                function Keybind:Show()
                    Keybind.Label.Visible = true
                    Keybind.Box.Visible = true
                    Keybind.KeyText.Visible = true
                end

                function Keybind:Hide()
                    Keybind.Label.Visible = false
                    Keybind.Box.Visible = false
                    Keybind.KeyText.Visible = false
                end

                table.insert(Groupbox.Elements, Keybind)
                Groupbox.CurrentY = Groupbox.CurrentY + Keybind.Height + 5
                Keybind:UpdatePosition(Groupbox.Position + Vector2.new(10, Groupbox.CurrentY - Keybind.Height - 5))
                Options[flag] = Keybind
                return Keybind
            end

            -- Textbox
            function Groupbox:AddTextbox(flag, opt)
                local Textbox = {}
                Textbox.Text = opt.Text or "Textbox"
                Textbox.Default = opt.Default or ""
                Textbox.Callback = opt.Callback or function() end
                Textbox.Value = Textbox.Default
                Textbox.Height = 20

                Textbox.Label = Drawing.new("Text")
                Textbox.Label.Text = Textbox.Text
                Textbox.Label.Size = Theme.TextSize
                Textbox.Label.Color = Theme.Text
                Textbox.Label.Visible = Groupbox.Visible

                Textbox.Box = Drawing.new("Square")
                Textbox.Box.Size = Vector2.new(Groupbox.Size.X - 40, 15)
                Textbox.Box.Filled = true
                Textbox.Box.Color = Theme.Background
                Textbox.Box.Visible = Groupbox.Visible

                Textbox.InputText = Drawing.new("Text")
                Textbox.InputText.Text = Textbox.Value
                Textbox.InputText.Position = Textbox.Box.Position + Vector2.new(5, 0)
                Textbox.InputText.Size = Theme.TextSize
                Textbox.InputText.Color = Theme.Text
                Textbox.InputText.Visible = Groupbox.Visible

                local typing = false

                UIS.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        local mouse = UIS:GetMouseLocation()
                        if mouse.X > Textbox.Box.Position.X and mouse.X < Textbox.Box.Position.X + Textbox.Box.Size.X and mouse.Y > Textbox.Box.Position.Y and mouse.Y < Textbox.Box.Position.Y + 15 then
                            typing = true
                        else
                            if typing then
                                if Textbox.Callback then Textbox.Callback(Textbox.Value) end
                                typing = false
                            end
                        end
                    end
                    if typing and input.UserInputType == Enum.UserInputType.Keyboard then
                        if input.KeyCode == Enum.KeyCode.Return then
                            if Textbox.Callback then Textbox.Callback(Textbox.Value) end
                            typing = false
                            return
                        end
                        if input.KeyCode == Enum.KeyCode.Backspace then
                            Textbox.Value = Textbox.Value:sub(1, -2)
                        else
                            Textbox.Value = Textbox.Value .. input.KeyCode.Name
                        end
                        Textbox.InputText.Text = Textbox.Value
                    end
                end)

                function Textbox:SetValue(val)
                    Textbox.Value = val
                    Textbox.InputText.Text = val
                    if Textbox.Callback then Textbox.Callback(val) end
                end

                function Textbox:OnChanged(cb)
                    Textbox.Callback = cb
                end

                function Textbox:UpdatePosition(pos)
                    Textbox.Label.Position = pos
                    Textbox.Box.Position = pos + Vector2.new(0, 15)
                    Textbox.InputText.Position = Textbox.Box.Position + Vector2.new(5, 0)
                end

                function Textbox:Show()
                    Textbox.Label.Visible = true
                    Textbox.Box.Visible = true
                    Textbox.InputText.Visible = true
                end

                function Textbox:Hide()
                    Textbox.Label.Visible = false
                    Textbox.Box.Visible = false
                    Textbox.InputText.Visible = false
                end

                table.insert(Groupbox.Elements, Textbox)
                Groupbox.CurrentY = Groupbox.CurrentY + Textbox.Height + 5
                Textbox:UpdatePosition(Groupbox.Position + Vector2.new(10, Groupbox.CurrentY - Textbox.Height - 5))
                Options[flag] = Textbox
                return Textbox
            end

            return Groupbox
        end

        function Tab:AddRightGroupbox(title)
            local Groupbox = Tab:AddLeftGroupbox(title)
            Groupbox.Position = Window.TabArea + Vector2.new(10 + Groupbox.Size.X + 10, 10)
            Groupbox:UpdatePosition()
            return Groupbox
        end

        return Tab
    end

    return Window
end

-- ThemeManager
local ThemeManager = {}
function ThemeManager:SetTheme(newTheme)
    Theme = newTheme
    -- Update all elements
    for _, window in ipairs(Library.Windows) do
        window.Background.Color = Theme.Background
        window.Outline.Color = Theme.Outline
        window.Titlebar.Color = Theme.Accent
        window.TitleText.Color = Theme.Text
        window.CloseText.Color = Theme.Text
        window.TabSidebar.Color = Theme.Outline
        window.Shadow.Color = Theme.Shadow
        for _, tab in ipairs(window.Tabs) do
            tab.TabButton.Color = tab == window.SelectedTab and Theme.Accent or Theme.Background
            tab.TabText.Color = Theme.Text
            for _, gb in ipairs(tab.Groupboxes) do
                gb.Background.Color = Theme.Outline
                gb.TitleText.Color = Theme.Text
                for _, elem in ipairs(gb.Elements) do
                    -- Update elem colors
                    if elem.Label then elem.Label.Color = Theme.Text end
                    if elem.Box then elem.Box.Color = elem.Value and Theme.Accent or Theme.Background end
                    if elem.Bar then elem.Bar.Color = Theme.Outline end
                    if elem.Fill then elem.Fill.Color = Theme.Accent end
                    if elem.ValueText then elem.ValueText.Color = Theme.Text end
                    if elem.Bg then elem.Bg.Color = Theme.Accent end
                    if elem.KeyText then elem.KeyText.Color = Theme.Text end
                    if elem.InputText then elem.InputText.Color = Theme.Text end
                    -- Sub buttons etc.
                    for _, sub in ipairs(elem.SubButtons or {}) do
                        sub.Bg.Color = Theme.Accent
                        sub.Label.Color = Theme.Text
                    end
                end
            end
        end
    end
end

-- SaveManager
local SaveManager = {}

local function serialize(tbl)
    local str = "{"
    for k, v in pairs(tbl) do
        local key = type(k) == "string" and '["' .. k .. '"]' or k
        local val
        if type(v) == "boolean" then
            val = tostring(v)
        elseif type(v) == "number" then
            val = v
        elseif type(v) == "string" then
            val = '"' .. v .. '"'
        elseif type(v) == "Color3" then
            val = 'Color3.new(' .. v.R .. ', ' .. v.G .. ', ' .. v.B .. ')'
        elseif type(v) == "EnumItem" then
            val = 'Enum.KeyCode.' .. v.Name
        else
            val = tostring(v)
        end
        str = str .. key .. " = " .. val .. ", "
    end
    return str .. "}"
end

function SaveManager:Save(configName)
    makefolder("configs")
    local data = {}
    for flag, toggle in pairs(Toggles) do
        data[flag] = toggle.Value
    end
    for flag, option in pairs(Options) do
        data[flag] = option.Value
    end
    writefile("configs/" .. configName .. ".lua", "return " .. serialize(data))
end

function SaveManager:Load(configName)
    if isfile("configs/" .. configName .. ".lua") then
        local data = loadstring(readfile("configs/" .. configName .. ".lua"))()
        for flag, val in pairs(data) do
            if Toggles[flag] then
                Toggles[flag]:SetValue(val)
            end
            if Options[flag] then
                Options[flag]:SetValue(val)
            end
        end
    end
end

-- End of library
return Library, ThemeManager, SaveManager
